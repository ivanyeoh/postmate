/**
  postmate - A powerful, simple, promise-based postMessage library
  @version v1.4.1
  @link https://github.com/dollarshaveclub/postmate
  @author Jacob Kelley <jakie8@gmail.com>
  @license MIT
**/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Postmate=e()}(this,function(){"use strict";var t="application/x-postmate-v1+json",e=Object.prototype.hasOwnProperty,n=0,i=function(e,n){return e.origin===n&&("object"==typeof e.data&&("postmate"in e.data&&(e.data.type===t&&!!{"handshake-reply":1,call:1,emit:1,reply:1,request:1}[e.data.postmate])))},r=function(t,e){var n="function"==typeof t[e]?t[e]():t[e];return c.Promise.resolve(n)},o=function(t){return new c.Promise(function(e,n){var i=document.createElement("iframe");i.onload=function(){e(i)},i.setAttribute("style","display: none; visibility: hidden;"),i.setAttribute("width","0"),i.setAttribute("height","0"),t.appendChild(i)})},a=function(){return new c.Promise(function(t){if(document&&document.body)return t(document.body);var e=setInterval(function(){if(document&&document.body)return clearInterval(e),t(document.body)},10)})},s=function(){function e(t){var e=this;this.parent=t.parent,this.frame=t.frame,this.child=t.child,this.childOrigin=t.childOrigin,this.events={},this.listener=function(n){var r=((n||{}).data||{}).value||{},o=r.data,a=r.name;i(n,t.childOrigin)&&"emit"===n.data.postmate&&a in e.events&&e.events[a].call(e,o)},this.parent.addEventListener("message",this.listener,!1)}var r=e.prototype;return r.get=function(e){var i=this;return new c.Promise(function(r){var o=++n;i.parent.addEventListener("message",function t(e){e.data.uid===o&&"reply"===e.data.postmate&&(i.parent.removeEventListener("message",t,!1),r(e.data.value))},!1),i.child.postMessage({postmate:"request",type:t,property:e,uid:o},i.childOrigin)})},r.call=function(e,n){this.child.postMessage({postmate:"call",type:t,property:e,data:n},this.childOrigin)},r.on=function(t,e){this.events[t]=e},r.destroy=function(){window.removeEventListener("message",this.listener,!1),this.frame.parentNode.removeChild(this.frame)},e}(),d=function(){function e(e){var n=this;this.model=e.model,this.parent=e.parent,this.parentOrigin=e.parentOrigin,this.child=e.child,this.child.addEventListener("message",function(e){if(i(e,n.parentOrigin)){var o=e.data,a=o.property,s=o.uid,d=o.data;"call"!==e.data.postmate?r(n.model,a).then(function(n){return e.source.postMessage({property:a,postmate:"reply",type:t,uid:s,value:n},e.origin)}):a in n.model&&"function"==typeof n.model[a]&&n.model[a].call(n,d)}})}return e.prototype.emit=function(e,n){this.parent.postMessage({postmate:"emit",type:t,value:{name:e,data:n}},this.parentOrigin)},e}(),c=function(){function e(t){var e=this,n=void 0===t?userOptions:t,i=n.model,r=n.url;return this.parent=window,this.model=i||{},a().then(function(t){return o(t)}).then(function(t){e.frame=t}).then(function(){return e.sendHandshake(r)})}return e.prototype.sendHandshake=function(n){var r,o=this,a=function(t){var e=document.createElement("a");e.href=t;var n=e.protocol.length>4?e.protocol:window.location.protocol,i=e.host.length?"80"===e.port||"443"===e.port?e.hostname:e.host:window.location.host;return e.origin||n+"//"+i}(n),d=0;return new e.Promise(function(e,c){var u=function t(n){return!!i(n,a)&&("handshake-reply"===n.data.postmate?(clearInterval(r),o.parent.removeEventListener("message",t,!1),o.childOrigin=n.origin,e(new s(o))):c("Failed handshake. postmate: "+n.data.postmate))},l=function(){d++,o.child.postMessage({postmate:"handshake",type:t,model:o.model},a),5===d&&clearInterval(r)},p=function(){o.child=function(t){if(!t.contentWindow)throw t.contentDocument&&t.contentDocument.parentWindow?new Error("iframe.contentWindow is null after onload for: "+t.src+", but got parentWindow!"):new Error("iframe.contentWindow is null after onload for: "+t.src);return t.contentWindow}(o.frame),o.parent.addEventListener("message",u,!1),l(),r=setInterval(l,500)};o.frame.attachEvent?o.frame.attachEvent("onload",p):o.frame.onload=p,o.frame.src=n})},e}();return c.debug=!1,c.Promise=function(){try{return window?window.Promise:Promise}catch(t){return null}}(),c.Model=function(){function n(t){return this.child=window,this.model=t,this.parent=this.child.parent,this.sendHandshakeReply()}return n.prototype.sendHandshakeReply=function(){var n=this;return new c.Promise(function(i,r){n.child.addEventListener("message",function o(a){if(a.data.postmate){if("handshake"===a.data.postmate){n.child.removeEventListener("message",o,!1),a.source.postMessage({postmate:"handshake-reply",type:t},a.origin),n.parentOrigin=a.origin;var s=a.data.model;if(s)for(var c=Object.keys(s),u=0;u<c.length;u++)e.call(s,c[u])&&(n.model[c[u]]=s[c[u]]);return i(new d(n))}return r("Handshake Reply Failed")}},!1)})},n}(),c});
